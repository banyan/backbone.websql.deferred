(function(){!function(a,b){return"object"==typeof exports&&"function"==typeof require?module.exports=b(require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["underscore","backbone"],function(c,d){return b(c||a._,d||a.Backbone)}):b(_,Backbone)}(this,function(a,b){var c,d,e,f;return c=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},d=function(){return""+c()+c()+"-"+c()+"-"+c()+"-"+c()+"-"+c()+c()+c()},f={number:"INTEGER",string:"TEXT",text:"TEXT",blob:"","float":"REAL","double":"REAL","boolean":"NUMERIC",datetime:"NUMERIC",date:"NUMERIC"},e=function(b){var c;if(b.type&&!(b.type in f))throw new Error("Unsupported type: "+b.type);return a.isString(b)?c="`"+b+"`":(c="`"+b.name+"`",b.type&&(c+=" "+f[b.type])),c},b.WebSQL=function(a,b,c,d){var f;if(this.db=a,this.tableName=b,this.columns=null!=c?c:[],this.indices=null!=d?d:[],!this._isWebSQLSupported())throw"Backbone.websql.deferred: Environment does not support WebSQL.";return f=["`id` unique","`value`"],c=f.concat(this.columns.map(e)),this._executeSql("CREATE TABLE IF NOT EXISTS `"+this.tableName+"` ("+c.join(", ")+");"),0!==this.indices.length?this._createIndex():void 0},b.WebSQL.insertOrReplace=!1,b.WebSQL.promiseType="jquery",a.extend(b.WebSQL.prototype,{create:function(c){var e,f,g,h,i,j,k,l;for(c.id||(c.id=d(),c.set(c.idAttribute,c.id)),f=["`id`","`value`"],i=["?","?"],h=[c.id.toString(),JSON.stringify(c.toJSON())],l=this.columns,j=0,k=l.length;k>j;j++)e=l[j],f.push("`"+(a.isString(e)?e:e.name)+"`"),i.push(["?"]),h.push(c.attributes[a.isString(e)?e:e.name]);return g=b.WebSQL.insertOrReplace?"OR REPLACE":"",this._executeSql("INSERT "+g+" INTO `"+this.tableName+"`("+f.join(",")+") VALUES ("+i.join(",")+");",h)},find:function(b,c,d,e){var f,g;if(f=[],g="SELECT `id`, `value` FROM `"+this.tableName+"`",e.where)if("string"==typeof e.where)g+=" WHERE "+e.where;else{if("object"!=typeof e.where)throw new Error("Unsupported where type: "+typeof e.where);g+=" WHERE "+Object.keys(e.where).map(function(b){var c;return a.isArray(e.where[b])?(f.push.apply(f,e.where[b]),c=[],a(e.where[b].length).times(function(){return c.push("?")}),"`"+b+"` IN ("+c.join()+")"):(f.push(e.where[b]),"`"+b+"` = ?")}).join(" AND ")}else g+=" WHERE  (`id` = ?);",f=[b.id.toString()];return this._executeSql(g,f,c,d,e)},findAll:function(b,c,d,e){var f,g;if(f=[],g="SELECT `id`, `value` FROM `"+this.tableName+"`",e.where)if("string"==typeof e.where)g+=" WHERE "+e.where;else{if("object"!=typeof e.where)throw new Error("Unsupported where type: "+typeof e.where);g+=" WHERE "+Object.keys(e.where).map(function(b){var c;return a.isArray(e.where[b])?(f.push.apply(f,e.where[b]),c=[],a(e.where[b].length).times(function(){return c.push("?")}),"`"+b+"` IN ("+c.join()+")"):(f.push(e.where[b]),"`"+b+"` = ?")}).join(" AND ")}return this._executeSql(g,f,c,d,e)},update:function(c,d,e,f){var g,h,i,j,k,l;if(b.WebSQL.insertOrReplace)return this.create(c,d,e);for(i=["`value` = ?"],h=[JSON.stringify(c.toJSON())],l=this.columns,j=0,k=l.length;k>j;j++)g=l[j],i.push("`"+(a.isString(g)?g:g.name)+"` = ?"),h.push(c.attributes[a.isString(g)?g:g.name]);return h.push(c.id.toString()),this._executeSql("UPDATE `"+this.tableName+"` SET "+i.join(", ")+" WHERE (`id` = ?);",h,function(a,b){return 1===b.rowsAffected?d(a,b):e(a,new Error("UPDATE affected "+b.rowsAffected+" rows"))},e,f)},destroy:function(a,b,c,d){return this._executeSql("DELETE FROM `"+this.tableName+"` WHERE (`id` = ?);",[a.id.toString()],b,c,d)},_isWebSQLSupported:function(){return!!window.openDatabase},_executeSql:function(a,b,c,d){return null==b&&(b=[]),this.db.transaction(function(e){return e.executeSql(a,b,c,d)})},_createIndex:function(){var b,c,d,e,f;if(null!=this.indices[0]&&a.isArray(this.indices[0])){for(e=this.indices,f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(this._executeSql("CREATE INDEX IF NOT EXISTS `"+this.tableName+"_"+b.join("_")+"` ON `"+this.tableName+"` ("+b.join(", ")+");"));return f}return this._executeSql("CREATE INDEX IF NOT EXISTS `"+this.tableName+"_"+this.indices.join("_")+"` ON `"+this.tableName+"` ("+this.indices.join(", ")+");")}}),b.WebSQL.sync=function(c,d,e){var f,g,h,i,j,k;switch(k=d.store||d.collection.store,i=!1,f=function(){var a;switch(j=b.WebSQL.promiseType){case"jquery":return null!=(a=b.$)?"function"==typeof a.Deferred?a.Deferred():void 0:void 0;case"q":return"undefined"!=typeof Q&&null!==Q?"function"==typeof Q.defer?Q.defer():void 0:void 0;default:throw new Error("Unsupported Backbone.WebSQL.promiseType: "+j)}}(),g=function(c,g){var h,j;return h=g.rows.length,j=[],a.times(h,function(a){return j.push(JSON.parse(g.rows.item(a).value))}),i&&0!==j.length&&(j=j[0]),(null!=e?e.success:void 0)&&("0.9.10"===b.VERSION?e.success(d,j,e):e.success(j)),null!=f?f.resolve(j):void 0},h=function(a,c){return console.error("Backbone.websql.deferred failed: ",c,a),(null!=e?e.error:void 0)&&("0.9.10"===b.VERSION?e.error(d,c,e):e.error(c)),null!=f?f.reject(c):void 0},c){case"read":d instanceof b.Collection?k.findAll(d,g,h,e):(i=!0,k.find(d,g,h,e));break;case"create":k.create(d,g,h,e);break;case"update":k.update(d,g,h,e);break;case"delete":k.destroy(d,g,h,e);break;default:throw new Error("Unsupported method: "+c)}return"jquery"===j?null!=f?f.promise():void 0:null!=f?f.promise:void 0},b.WebSQL.ajaxSync=b.sync,b.WebSQL.getSyncMethod=function(a){var c;return a.store||(null!=(c=a.collection)?c.store:void 0)?b.WebSQL.sync:b.WebSQL.ajaxSync},b.sync=function(a,c,d){return b.WebSQL.getSyncMethod(c).apply(this,[a,c,d])},b.WebSQL})}).call(this);